name: Scheduled Build

# Run a full build, lint, and audit cycle every Monday at 08:00 UTC so that
# broken dependencies (new npm package versions, security advisories, etc.)
# are caught before a developer tries to land a PR on a broken base.
#
# This workflow is intentionally separate from the per-PR CI workflow so that
# scheduled failures do not block PR merges and vice-versa.
on:
  schedule:
    - cron: '0 8 * * 1'   # Every Monday 08:00 UTC
  workflow_dispatch: {}    # Allow manual triggering from the Actions UI

jobs:
  full-build:
    name: Full Build & Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # ── Frontend ─────────────────────────────────────────────────────────

      - name: Frontend — install dependencies
        working-directory: frontend
        run: npm ci

      - name: Frontend — lint
        working-directory: frontend
        run: npm run lint

      - name: Frontend — build
        working-directory: frontend
        run: npm run build

      - name: Frontend — audit
        working-directory: frontend
        run: npm audit --audit-level=high
        continue-on-error: true   # report but don't fail the build for moderate findings

      # ── E2E dependencies ─────────────────────────────────────────────────

      - name: E2E — install dependencies
        working-directory: e2e
        run: npm ci

      - name: E2E — audit
        working-directory: e2e
        run: npm audit --audit-level=high
        continue-on-error: true

  # Notify on failure via a GitHub issue (visible without checking Actions logs).
  notify-on-failure:
    name: Create issue on failure
    runs-on: ubuntu-latest
    needs: full-build
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Scheduled build failed — ${new Date().toISOString().slice(0,10)}`;
            const body = [
              '## Scheduled Build Failure',
              '',
              `**Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              '',
              'The weekly scheduled build failed.  Please investigate and fix before the next release.',
              '',
              'Common causes:',
              '- A transitive npm dependency published a breaking change',
              '- A high-severity npm audit finding was introduced',
              '- A lint rule started flagging new code patterns',
              '- The Node.js 20 base image changed in a breaking way',
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['bug', 'ci'],
            });
